# Fuzzing for wc-rs

This directory contains fuzz targets for testing wc-rs with randomly generated inputs.

## Fuzz Targets

### 1. `fuzz_word_count`
Tests the core word counting logic with arbitrary byte sequences in both UTF-8 and SingleByte locale modes.

**What it tests:**
- No panics or crashes with any input
- Proper handling of invalid bytes
- Overflow/underflow safety

### 2. `fuzz_utf8`
Specifically targets UTF-8 handling, including invalid and malformed sequences.

**What it tests:**
- Invariants: `chars <= bytes`, `lines <= bytes`
- Valid UTF-8 matches Rust's standard library
- Graceful handling of invalid UTF-8
- Incomplete UTF-8 sequence detection

### 3. `fuzz_simd_consistency`
Compares all SIMD implementations against the scalar baseline.

**What it tests:**
- SSE2, AVX2, AVX512 (on x86_64) match scalar
- NEON, SVE (on aarch64) match scalar
- Consistency across both UTF-8 and SingleByte modes

## Running Fuzz Tests

### Quick Start

Run a specific fuzz target with shared corpus:
```bash
cd fuzz
cargo fuzz run fuzz_word_count corpus/shared
```

### Run with time limit
```bash
cargo fuzz run fuzz_word_count corpus/shared -- -max_total_time=60
```

### Run with multiple jobs (parallel fuzzing)
```bash
cargo fuzz run fuzz_word_count corpus/shared -- -jobs=4
```

### Run all targets with the Rust CLI

```bash
cargo run --bin fuzz-runner --release              # 60s per target (default)
cargo run --bin fuzz-runner --release -- -t 120    # 120s per target
cargo run --bin fuzz-runner --release -- -m 1      # Run once then stop
cargo run --bin fuzz-runner --release -- --help    # See all options
```

## Common Options

- `-max_total_time=N` - Run for N seconds
- `-jobs=N` - Use N parallel fuzzing jobs
- `-runs=N` - Stop after N runs
- `-max_len=N` - Limit input size to N bytes
- `-dict=file` - Use dictionary file for mutations

## Reproducing Crashes

If fuzzing finds a crash, it saves the input to `artifacts/`:
```bash
# Run with the crashing input
cargo fuzz run fuzz_word_count artifacts/fuzz_word_count/crash-abc123...
```

## Minimizing Crashes

Reduce a crashing input to the smallest reproduction:
```bash
cargo fuzz tmin fuzz_word_count artifacts/fuzz_word_count/crash-abc123...
```

## Coverage Report

Generate coverage information:
```bash
cargo fuzz coverage fuzz_word_count
```

## Corpus Management

### Directory Structure

```
seeds/              â† Your hand-crafted seed files (git tracked, safe to edit)
â”œâ”€â”€ ascii.txt
â”œâ”€â”€ utf8.txt
â”œâ”€â”€ empty.txt
â”œâ”€â”€ invalid_utf8.txt
â””â”€â”€ ...

corpus/shared/      â† Auto-generated by fuzzer (can be deleted/regenerated)
â”œâ”€â”€ [90+ files with hash names]
```

### Seeds vs Corpus

- **seeds/** - Your 7 carefully crafted seed files
  - Safe to edit and modify
  - Git tracked
  - Cover edge cases: UTF-8, invalid bytes, empty, whitespace, etc.

- **corpus/shared/** - Fuzzer-generated files
  - Hundreds of auto-generated test cases
  - Can be deleted anytime (fuzzer will regenerate)
  - Shared between all fuzz targets

### Initialize/Reset Corpus

To start fresh or reset corpus from seeds:
```bash
./init_corpus.sh
```

Or manually:
```bash
rm -rf corpus/shared/*
cp seeds/* corpus/shared/
```

### Clean Corpus Without Losing Seeds

```bash
# Safe - only removes fuzzer-generated files
rm -rf corpus/shared/*
./init_corpus.sh

# Your seeds/ folder is untouched!
```

### Minimize Corpus

Remove redundant corpus files:
```bash
cargo fuzz cmin fuzz_word_count corpus/shared
```

## Continuous Fuzzing (Overnight)

**Rust CLI tool** with auto-initialization, proper signal handling and statistics logging:

```bash
# Quick test - 60 seconds per target (default)
cargo run --bin fuzz-runner --release

# Custom time per target
cargo run --bin fuzz-runner --release -- --time 300    # 5 minutes per target
cargo run --bin fuzz-runner --release -- -t 120        # 2 minutes per target

# Run forever (no time limit per target)
cargo run --bin fuzz-runner --release -- --infinity

# Run for specific number of iterations
cargo run --bin fuzz-runner --release -- --max-iterations 10

# See all options
cargo run --bin fuzz-runner --release -- --help
```

**Features:**
- âœ… **Auto-initialization** - Automatically copies seeds to corpus if empty
- âœ… Proper signal handling (graceful Ctrl+C)
- âœ… Real-time statistics (coverage, exec/s, crashes)
- âœ… JSON stats export for analysis
- âœ… Clean, structured output
- âœ… No crashes on interrupt

**Output example:**
```
==================================================
ðŸš€ Continuous Fuzzing Runner
==================================================
Start time: 2024-11-20 13:00:00
Time per run: 300s
Targets: fuzz_word_count, fuzz_utf8, fuzz_simd_consistency
Log file: logs/fuzz_20241120_130000.log
Stats file: logs/stats_20241120_130000.json
Press Ctrl+C to stop gracefully
==================================================

=========================================
ðŸ“Š Iteration 1 - 13:00:05
=========================================

--- Running: fuzz_word_count ---
  â±ï¸  Duration: 300s
  ðŸ“¦ Corpus: 250 files
  ðŸ“ˆ Coverage: 84
  âš¡ Speed: 1250 exec/s
  âœ“ Exit code: 0

--- Running: fuzz_utf8 ---
  ðŸš¨ CRASH FOUND! 1 crash(es) in artifacts/fuzz_utf8
  â±ï¸  Duration: 300s
  ðŸ“¦ Corpus: 265 files
  ðŸ“ˆ Coverage: 81
  âš¡ Speed: 980 exec/s
  ðŸ’¥ Crashes: 1
  âœ“ Exit code: 0
```

**Statistics saved to:**
- `logs/fuzz_YYYYMMDD_HHMMSS.log` - Human-readable log
- `logs/stats_YYYYMMDD_HHMMSS.json` - Structured JSON stats for analysis

**To stop:** Press `Ctrl+C` (stops gracefully after current target)

## Integration with CI

For continuous fuzzing in CI:
```bash
# Run each target for 60 seconds with shared corpus
cargo fuzz run fuzz_word_count corpus/shared -- -max_total_time=60 -rss_limit_mb=4096
cargo fuzz run fuzz_utf8 corpus/shared -- -max_total_time=60 -rss_limit_mb=4096
cargo fuzz run fuzz_simd_consistency corpus/shared -- -max_total_time=60 -rss_limit_mb=4096
```

## Tips

1. **Start with short runs** - Try 60 seconds per target first
2. **Use parallel jobs** - Speed up fuzzing with `-jobs=<num_cpus>`
3. **Monitor coverage** - Check `coverage/` to see what's being tested
4. **Share corpus** - Commit interesting corpus files to git
5. **Long runs** - For thorough testing, run overnight with no time limit

## Resources

- [cargo-fuzz documentation](https://rust-fuzz.github.io/book/cargo-fuzz.html)
- [libFuzzer options](https://llvm.org/docs/LibFuzzer.html#options)
